<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sing-box Sub Converter</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Toperlock/sing-box-subscribe/main/public/favicon.ico" type="image/x-icon">
    <style>
        :root { --bg-color: #f5f7f9; --card-bg: #ffffff; --text-color: #333; --border-color: #e0e4e8; --primary-color: #007aff; --accent-color: #34c759; --danger-color: #ff3b30; }
        .dark-mode { --bg-color: #1a1a1a; --card-bg: #2a2a2a; --text-color: #f0f0f0; --border-color: #444; --primary-color: #0a84ff; }

        body, .card, .combo-input, input[type="text"], button, .sub-item { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }

        * { -webkit-tap-highlight-color: transparent; outline: none !important; }

        .container { width: 100%; max-width: 900px; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .controls { display: flex; gap: 10px; align-items: center; }

        @media (max-width: 600px) {
            .header { flex-direction: column; text-align: center; }
            .header h2 { margin: 0; }
            .controls { width: 100%; justify-content: center; }
            .btn-ghost { flex: 1; padding: 12px 10px; font-size: 14px; min-width: 100px; }
        }

        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid var(--border-color); }

        .sub-item { position: relative; padding: 30px 20px 20px 20px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; background: rgba(128,128,128,0.02); }
        .remove-btn { position: absolute; top: 8px; right: 8px; color: var(--danger-color); cursor: pointer; font-weight: bold; padding: 10px; z-index: 10; font-size: 14px; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 10px; }
        .input-group { display: flex; flex-direction: column; margin-bottom: 15px; position: relative; }
        label { font-size: 12px; margin-bottom: 4px; opacity: 0.8; }

        .combo-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); box-sizing: border-box; font-size: 14px; cursor: pointer; position: relative; }

        .dropdown-menu { 
            display: none; position: absolute; top: 100%; left: 0; right: 0; 
            background: var(--card-bg); border: 1px solid var(--border-color); 
            border-radius: 8px; margin-top: 4px; z-index: 1000; 
            max-height: 250px; overflow-y: auto; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .dropdown-menu.show { display: block; }

        .option-item { padding: 10px 15px; cursor: pointer; transition: background 0.2s; font-size: 14px; }
        .option-item:hover { background: rgba(128,128,128,0.1); }
        .option-item.selected { color: var(--primary-color); font-weight: bold; background: rgba(0,122,255,0.08); }

        .select-trigger::after { content: ""; position: absolute; right: 15px; top: 50%; width: 8px; height: 8px; border-right: 2px solid var(--text-color); border-bottom: 2px solid var(--text-color); transform: translateY(-70%) rotate(45deg); opacity: 0.6; }

        .checkbox-group { display: flex; align-items: center; gap: 8px; font-size: 14px; }
        button { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; }
        .btn-add { background: var(--accent-color); color: white; margin-bottom: 15px; }
        .btn-primary { background: var(--primary-color); color: white; width: 100%; font-size: 16px; }
        .btn-ghost { background: transparent; border: 1px solid var(--border-color); color: var(--text-color); }

        #result-area { margin-top: 20px; display: none; }
        .url-display { background: rgba(0,0,0,0.05); padding: 15px; border-radius: 8px; word-break: break-all; font-family: monospace; font-size: 13px; border: 1px solid var(--border-color); margin-bottom: 10px; }
    </style>
</head>
<body class="dark-mode">
    <script>
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if (savedTheme === 'light') document.body.classList.remove('dark-mode');
    </script>

    <div id="data-templates" style="display: none;">
        {% for option in template_options %}
        <span class="template-opt" data-index="{{ loop.index }}" data-label="{{ option }}"></span>
        {% endfor %}
    </div>

    <div class="container">
        <div class="header">
            <h2 data-translate="title">Sing-box Sub Converter</h2>
            <div class="controls">
                <button class="btn-ghost" onclick="toggleLanguage()" data-translate="lang_btn">中文</button>
                <button class="btn-ghost" onclick="toggleTheme()" data-translate="theme_btn">Toggle Theme</button>
            </div>
        </div>

        <div class="card">
            <h3 data-translate="global_settings">Global Settings</h3>
            
            <div class="input-group">
                <label data-translate="label_file">Template (Double-click to manual input)</label>
                <div id="template-trigger" class="combo-input select-trigger" onclick="toggleDropdown(event, 'template-menu')" ondblclick="switchToInput()">Select Template...</div>
                <div id="template-menu" class="dropdown-menu"></div>
                <input type="text" id="template-manual" class="combo-input" style="display:none;" ondblclick="switchToSelect()" placeholder="Enter template index or URL">
            </div>

            <div class="input-group">
                <label data-translate="label_gh">GitHub Proxy</label>
                <div id="gh-trigger" class="combo-input select-trigger" onclick="toggleDropdown(event, 'gh-menu')">None (Do not modify)</div>
                <div id="gh-menu" class="dropdown-menu"></div>
            </div>

            <div class="input-group">
                <label>&nbsp;</label>
                <div class="checkbox-group">
                    <input type="checkbox" id="global-onlynodes">
                    <span data-translate="label_onlynodes">Only-nodes</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 data-translate="sub_list">Subscription List</h3>
                <button class="btn-add" onclick="addSubBlock()" data-translate="add_sub">+ Add Subscription</button>
            </div>
            <div id="sub-container"></div>
            <button class="btn-primary" onclick="generateURL()" data-translate="generate_btn">Generate Conversion URL</button>
        </div>

        <div id="result-area" class="card">
            <h3 data-translate="result_title">Generated URL</h3>
            <div id="url-output" class="url-display"></div>
            <button class="btn-primary" style="background: var(--accent-color);" onclick="copyURL()" data-translate="copy_btn">Copy URL</button>
        </div>
    </div>

    <script>
        const i18n = {
            zh: {
                title: "Sing-box 订阅转换生成",
                global_settings: "全局设置",
                sub_list: "订阅列表",
                add_sub: "+ 添加订阅",
                generate_btn: "确认并生成转换链接",
                lang_btn: "English",
                theme_btn: "切换主题",
                label_file: "模板文件 (Template)",
                label_gh: "GitHub 代理 (gh)",
                label_onlynodes: "仅节点 (Only-nodes)",
                label_url: "订阅地址 (URL)",
                label_tag: "标签 (Tag)",
                label_subgroup: "分组 (Subgroup)",
                label_prefix: "前缀 (Prefix)",
                label_suffix: "后缀 (Suffix)",
                label_ua: "自定义 UA",
                label_emoji: "启用 Emoji",
                result_title: "生成的订阅链接",
                copy_btn: "复制链接",
                copy_msg: "链接已复制",
                remove: "删除",
                select_prompt: "请选择选项",
                custom_input: "-- 自定义输入 --",
                gh_none: "不做修改 (None)"
            },
            en: {
                title: "Sing-box Sub Converter",
                global_settings: "Global Settings",
                sub_list: "Subscription List",
                add_sub: "+ Add Subscription",
                generate_btn: "Generate Conversion URL",
                lang_btn: "中文",
                theme_btn: "Toggle Theme",
                label_file: "Template Settings",
                label_gh: "GitHub Proxy (gh)",
                label_onlynodes: "Only-nodes",
                label_url: "Subscription URL",
                label_tag: "Tag",
                label_subgroup: "Subgroup",
                label_prefix: "Prefix",
                label_suffix: "Suffix",
                label_ua: "Custom UA",
                label_emoji: "Enable Emoji",
                result_title: "Generated URL",
                copy_btn: "Copy URL",
                copy_msg: "URL copied",
                remove: "Remove",
                select_prompt: "Select Option",
                custom_input: "-- Custom Input --",
                gh_none: "None (Do not modify)"
            }
        };

        let currentLang = 'en';
        let selectedTemplateValue = "1";
        let selectedGHValue = "none";

        const templateOptions = Array.from(document.querySelectorAll('.template-opt')).map(el => ({
            value: el.getAttribute('data-index'),
            label: el.getAttribute('data-label')
        }));

        const ghOptions = [
            { value: "none", label: "None (Do not modify)" },
            { value: "1", label: "gh-proxy" },
            { value: "2", label: "cnxiaobai" },
            { value: "3", label: "ghfast" },
            { value: "4", label: "chenc" },
            { value: "5", label: "jsDelivr" },
            { value: "6", label: "jsDelivr-CF" },
            { value: "7", label: "jsDelivr-Fastly" },
            { value: "8", label: "onmicrosoft" }
        ];

        window.onload = () => {
            const savedLang = localStorage.getItem('language');
            if (savedLang) currentLang = savedLang;
            initDropdowns();
            updateLanguage();
            addSubBlock();
        };

        function renderList(menuId, options, currentVal, callback) {
            const container = document.getElementById(menuId);
            container.innerHTML = '';
            options.forEach(opt => {
                const item = document.createElement('div');
                const isSelected = String(opt.value) === String(currentVal);
                item.className = 'option-item' + (isSelected ? ' selected' : '');

                let labelText = opt.label;
                if (opt.value === 'none') labelText = i18n[currentLang].gh_none;
                if (opt.value === 'custom') labelText = i18n[currentLang].custom_input;

                item.textContent = labelText;
                item.onclick = (e) => { e.stopPropagation(); callback(opt.value, labelText); };
                container.appendChild(item);
            });
        }

        function initDropdowns() {
            renderList('template-menu', [...templateOptions, { value: 'custom', label: i18n[currentLang].custom_input }], selectedTemplateValue, (val, label) => {
                if (val === 'custom') switchToInput();
                else { selectedTemplateValue = val; document.getElementById('template-trigger').textContent = label; }
                hideAllDropdowns();
            });

            renderList('gh-menu', ghOptions, selectedGHValue, (val, label) => {
                selectedGHValue = val;
                document.getElementById('gh-trigger').textContent = label;
                hideAllDropdowns();
            });
        }

        function toggleDropdown(e, menuId) {
            e.stopPropagation();
            const menu = document.getElementById(menuId);
            const isShow = menu.classList.contains('show');
            hideAllDropdowns();
            if (!isShow) {
                if (menuId === 'template-menu') {
                    renderList('template-menu', [...templateOptions, { value: 'custom', label: i18n[currentLang].custom_input }], selectedTemplateValue, (val, label) => {
                        if (val === 'custom') switchToInput();
                        else { selectedTemplateValue = val; document.getElementById('template-trigger').textContent = label; }
                        hideAllDropdowns();
                    });
                } else {
                    renderList('gh-menu', ghOptions, selectedGHValue, (val, label) => {
                        selectedGHValue = val;
                        document.getElementById('gh-trigger').textContent = label;
                        hideAllDropdowns();
                    });
                }
                menu.classList.add('show');
            }
        }

        function hideAllDropdowns() {
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
        }

        window.onclick = () => hideAllDropdowns();

        function switchToInput() { document.getElementById('template-trigger').style.display = 'none'; const input = document.getElementById('template-manual'); input.style.display = 'block'; input.focus(); }
        function switchToSelect() { document.getElementById('template-manual').style.display = 'none'; document.getElementById('template-trigger').style.display = 'block'; }

        function addSubBlock() {
            const container = document.getElementById('sub-container');
            const id = Date.now();
            const html = `
                <div class="sub-item" id="block-${id}">
                    <span class="remove-btn" onclick="removeBlock(${id})">${i18n[currentLang].remove}</span>
                    <div class="input-group" style="margin-top: 10px;">
                        <label data-translate="label_url">${i18n[currentLang].label_url}</label>
                        <input type="text" class="sub-url combo-input" placeholder="https://...">
                    </div>
                    <div class="form-grid">
                        <div class="input-group"><label data-translate="label_ua">${i18n[currentLang].label_ua}</label><input type="text" class="sub-ua combo-input" placeholder="sing-box"></div>
                        <div class="input-group"><label data-translate="label_suffix">${i18n[currentLang].label_suffix}</label><input type="text" class="sub-suffix combo-input" placeholder="Optional"></div>
                        <div class="input-group"><label data-translate="label_prefix">${i18n[currentLang].label_prefix}</label><input type="text" class="sub-prefix combo-input" placeholder="Optional"></div>
                        <div class="input-group"><label data-translate="label_subgroup">${i18n[currentLang].label_subgroup}</label><input type="text" class="sub-subgroup combo-input" placeholder="Optional"></div>
                        <div class="input-group"><label data-translate="label_tag">${i18n[currentLang].label_tag}</label><input type="text" class="sub-tag combo-input" placeholder="Optional"></div>
                        <div class="input-group"><label>&nbsp;</label><div class="checkbox-group"><input type="checkbox" class="sub-emoji"><span data-translate="label_emoji">${i18n[currentLang].label_emoji}</span></div></div>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        function removeBlock(id) { document.getElementById(`block-${id}`)?.remove(); }

        function generateURL() {
            const baseURL = window.location.origin + "/config/";
            const subItems = document.querySelectorAll('.sub-item');

            let urls = [], emojis = [], tags = [], subgroups = [], prefixes = [], suffixes = [], uas = [];

            subItems.forEach(item => {
                const u = item.querySelector('.sub-url').value.trim();
                if (u) {
                    urls.push(u);
                    emojis.push(item.querySelector('.sub-emoji').checked ? "1" : "0");

                    const tagVal = item.querySelector('.sub-tag').value.trim();
                    if (tagVal) tags.push(tagVal);

                    const sgVal = item.querySelector('.sub-subgroup').value.trim();
                    if (sgVal) subgroups.push(sgVal);

                    const preVal = item.querySelector('.sub-prefix').value.trim();
                    if (preVal) prefixes.push(preVal);

                    const sufVal = item.querySelector('.sub-suffix').value.trim();
                    if (sufVal) suffixes.push(sufVal);

                    const uaVal = item.querySelector('.sub-ua').value.trim();
                    if (uaVal) uas.push(uaVal);
                }
            });

            if (urls.length === 0) { alert(currentLang === 'zh' ? "请填写订阅地址" : "Please enter URL"); return; }

            const params = [];

            params.push(`url=${encodeURIComponent(urls.join('|'))}`);

            const shouldAddEmoji = !(urls.length === 1 && emojis[0] === "1");
            if (shouldAddEmoji) {
                params.push(`emoji=${encodeURIComponent(emojis.join('|'))}`);
            }

            const addEnc = (key, list) => { 
                if (list.length > 0) {
                    params.push(`${key}=${encodeURIComponent(list.join('|'))}`);
                }
            };

            addEnc('tag', tags); 
            addEnc('subgroup', subgroups); 
            addEnc('prefix', prefixes); 
            addEnc('suffix', suffixes); 
            addEnc('UA', uas);

            const manual = document.getElementById('template-manual');
            const fileVal = (manual.style.display === 'block') ? manual.value.trim() : selectedTemplateValue;
            if (fileVal && fileVal !== 'custom') params.push(`file=${encodeURIComponent(fileVal)}`);

            if (selectedGHValue !== "none") params.push(`gh=${encodeURIComponent(selectedGHValue)}`);
            if (document.getElementById('global-onlynodes').checked) params.push(`onlynodes=1`);

            const resultURL = baseURL + "?" + params.join('&');
            document.getElementById('url-output').textContent = resultURL;
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('result-area').scrollIntoView({ behavior: 'smooth' });
        }

        function copyURL() { navigator.clipboard.writeText(document.getElementById('url-output').textContent).then(() => alert(i18n[currentLang].copy_msg)); }
        function toggleTheme() { const isDark = document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); }
        function toggleLanguage() { currentLang = currentLang === 'zh' ? 'en' : 'zh'; localStorage.setItem('language', currentLang); updateLanguage(); }

        function updateLanguage() {
            const lang = i18n[currentLang];
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (lang[key]) el.textContent = lang[key];
            });
            document.querySelectorAll('.remove-btn').forEach(el => el.textContent = lang.remove);

            if (selectedGHValue === 'none') {
                document.getElementById('gh-trigger').textContent = lang.gh_none;
            } else {
                const ghOpt = ghOptions.find(o => String(o.value) === String(selectedGHValue));
                if (ghOpt) document.getElementById('gh-trigger').textContent = ghOpt.label;
            }
            
            const trigger = document.getElementById('template-trigger');
            const tmplOpt = templateOptions.find(o => String(o.value) === String(selectedTemplateValue));
            if (trigger.style.display !== 'none') {
                trigger.textContent = tmplOpt ? tmplOpt.label : lang.select_prompt;
            }
        }
    </script>
</body>
</html>